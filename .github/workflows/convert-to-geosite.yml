name: Convert to Geosite

on:
  # åœ¨ä¸» workflow å®ŒæˆåŽè‡ªåŠ¨è¿è¡Œ
  workflow_run:
    workflows: ["Update DoH Rules"]
    types:
      - completed
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  convert-to-geosite:
    runs-on: ubuntu-latest
    
    # åªåœ¨ä¸» workflow æˆåŠŸæ—¶è¿è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ”„ Convert to Geosite format
        run: |
          echo "å¼€å§‹è½¬æ¢ .list è§„åˆ™ä¸º geosite æ ¼å¼..."
          python src/geosite_converter.py
          echo ""
          echo "è½¬æ¢å®Œæˆï¼"
      
      - name: ðŸ“Š Display conversion results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ ç”Ÿæˆçš„ Geosite æ–‡ä»¶"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ls -lh rules/geosite* 2>/dev/null || echo "æœªæ‰¾åˆ° geosite æ–‡ä»¶"
          echo ""
          
          if [ -f rules/geosite_doh.json ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“„ geosite_doh.json å†…å®¹é¢„è§ˆ"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            head -n 30 rules/geosite_doh.json
            echo "..."
          fi
          
          if [ -f rules/geosite_doh.txt ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“„ geosite_doh.txt å†…å®¹é¢„è§ˆ"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            head -n 20 rules/geosite_doh.txt
          fi
      
      - name: ðŸ” Check for changes
        id: check_changes
        run: |
          git add rules/geosite*
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Geosite æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ“ æ£€æµ‹åˆ° Geosite æ–‡ä»¶å˜åŒ–"
          fi
      
      - name: ðŸ’¾ Commit and push geosite files
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ‹‰å–æœ€æ–°æ›´æ”¹
          git pull --rebase origin main || echo "æ— æ³• rebaseï¼Œç»§ç»­..."
          
          # æäº¤ geosite æ–‡ä»¶
          git add rules/geosite_doh.json rules/geosite_doh.txt
          git commit -m "ðŸ”„ Auto-convert to geosite format

          - Generated geosite_doh.json (JSON format)
          - Generated geosite_doh.txt (text format for reference)
          - æ›´æ–°æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          Generated by GitHub Actions" || {
            echo "âš ï¸  æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
            exit 0
          }
          
          # æŽ¨é€æ›´æ”¹
          for i in {1..3}; do
            if git push origin main; then
              echo "âœ… æˆåŠŸæŽ¨é€ geosite æ–‡ä»¶åˆ°è¿œç¨‹ä»“åº“"
              break
            else
              echo "âš ï¸  æŽ¨é€å¤±è´¥ï¼Œç¬¬ $i æ¬¡é‡è¯•..."
              git pull --rebase origin main
              sleep 2
            fi
            
            if [ $i -eq 3 ]; then
              echo "âŒ æŽ¨é€å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            fi
          done
      
      - name: ðŸ“¢ Create summary
        if: always()
        run: |
          echo "## ðŸ”„ Geosite è½¬æ¢å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f rules/geosite_doh.json ]; then
            CATEGORIES=$(grep -c '"name"' rules/geosite_doh.json || echo "0")
            echo "- ðŸ“¦ **åˆ†ç±»æ•°é‡**: ${CATEGORIES}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ç”Ÿæˆçš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`geosite_doh.json\` - JSON æ ¼å¼ï¼ˆå¯è½¬æ¢ä¸º .datï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- \`geosite_doh.txt\` - æ–‡æœ¬æ ¼å¼ï¼ˆä¾¿äºŽæŸ¥çœ‹ï¼‰" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— åœ¨ Mihomo ä¸­ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ–¹å¼ 1: ç›´æŽ¥ä½¿ç”¨ domain æ ¼å¼ï¼ˆæŽ¨èï¼‰**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "rule-providers:" >> $GITHUB_STEP_SUMMARY
          echo "  doh-foreign:" >> $GITHUB_STEP_SUMMARY
          echo "    type: http" >> $GITHUB_STEP_SUMMARY
          echo "    behavior: domain" >> $GITHUB_STEP_SUMMARY
          echo "    url: \"https://raw.githubusercontent.com/${{ github.repository }}/main/rules/doh_foreign.yaml\"" >> $GITHUB_STEP_SUMMARY
          echo "    interval: 86400" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "rules:" >> $GITHUB_STEP_SUMMARY
          echo "  - RULE-SET,doh-foreign,ðŸš€ èŠ‚ç‚¹é€‰æ‹©" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ–¹å¼ 2: å¦‚éœ€ä½¿ç”¨ geositeï¼ˆéœ€è¦è½¬æ¢å·¥å…·ï¼‰**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸‹è½½ \`geosite_doh.json\`" >> $GITHUB_STEP_SUMMARY
          echo "2. ä½¿ç”¨ [v2ray-rules-dat](https://github.com/Loyalsoldier/v2ray-rules-dat) è½¬æ¢ä¸º .dat" >> $GITHUB_STEP_SUMMARY
          echo "3. æ”¾å…¥ Mihomo é…ç½®ç›®å½•" >> $GITHUB_STEP_SUMMARY
          echo "4. é…ç½®è§„åˆ™:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "rules:" >> $GITHUB_STEP_SUMMARY
          echo "  - GEOSITE,doh-foreign,ðŸš€ èŠ‚ç‚¹é€‰æ‹©" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Geosite æ–‡ä»¶å·²æ›´æ–°å¹¶æŽ¨é€åˆ° \`main\` åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸  Geosite æ–‡ä»¶æ— å˜åŒ–ï¼Œæœªäº§ç”Ÿæ–°çš„æäº¤" >> $GITHUB_STEP_SUMMARY
          fi
