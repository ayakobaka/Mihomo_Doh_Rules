name: Convert to Geosite DAT

on:
  # åœ¨ä¸» workflow å®ŒæˆåŽè‡ªåŠ¨è¿è¡Œ
  workflow_run:
    workflows: ["Update DoH Rules"]
    types:
      - completed
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  convert-to-dat:
    runs-on: ubuntu-latest
    
    # åªåœ¨ä¸» workflow æˆåŠŸæ—¶è¿è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ”„ Convert to Geosite DAT format
        run: |
          echo "å¼€å§‹è½¬æ¢ .list è§„åˆ™ä¸º geosite .dat æ ¼å¼..."
          python src/geosite_converter.py
          echo ""
          echo "è½¬æ¢å®Œæˆï¼"
      
      - name: ðŸ“Š Display conversion results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ ç”Ÿæˆçš„ Geosite DAT æ–‡ä»¶"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -f rules/doh_foreign.dat ]; then
            ls -lh rules/doh_foreign.dat
            echo ""
            echo "ðŸ“„ doh_foreign.dat ä¿¡æ¯:"
            cat rules/doh_foreign_info.txt 2>/dev/null || echo "ä¿¡æ¯æ–‡ä»¶æœªç”Ÿæˆ"
          fi
          
          echo ""
          
          if [ -f rules/doh_china.dat ]; then
            ls -lh rules/doh_china.dat
            echo ""
            echo "ðŸ“„ doh_china.dat ä¿¡æ¯:"
            cat rules/doh_china_info.txt 2>/dev/null || echo "ä¿¡æ¯æ–‡ä»¶æœªç”Ÿæˆ"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Protocol Buffers äºŒè¿›åˆ¶æ ¼å¼ç”ŸæˆæˆåŠŸ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: ðŸ” Check for changes
        id: check_changes
        run: |
          # æ·»åŠ å­˜åœ¨çš„æ–‡ä»¶
          git add rules/*.dat 2>/dev/null || true
          git add rules/*_info.txt 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  DAT æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ“ æ£€æµ‹åˆ° DAT æ–‡ä»¶å˜åŒ–"
          fi
      
      - name: ðŸ’¾ Commit and push DAT files
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ‹‰å–æœ€æ–°æ›´æ”¹
          git pull --rebase origin main || echo "æ— æ³• rebaseï¼Œç»§ç»­..."
          
          # ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼‰
          if [ -f rules/doh_foreign.dat ]; then
            FOREIGN_SIZE=$(ls -lh rules/doh_foreign.dat | awk '{print $5}')
          else
            FOREIGN_SIZE="N/A"
          fi
          
          if [ -f rules/doh_china.dat ]; then
            CHINA_SIZE=$(ls -lh rules/doh_china.dat | awk '{print $5}')
          else
            CHINA_SIZE="N/A"
          fi
          
          # æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
          git add rules/*.dat 2>/dev/null || true
          git add rules/*_info.txt 2>/dev/null || true
          
          # æäº¤ DAT æ–‡ä»¶
          git commit -m "ðŸ”„ Auto-convert to geosite.dat format

          - doh_foreign.dat (${FOREIGN_SIZE})
          - doh_china.dat (${CHINA_SIZE})
          - Protocol Buffers binary format
          - æ›´æ–°æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          Generated by GitHub Actions" || {
            echo "âš ï¸  æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
            exit 0
          }
          
          # æŽ¨é€æ›´æ”¹
          for i in {1..3}; do
            if git push origin main; then
              echo "âœ… æˆåŠŸæŽ¨é€ DAT æ–‡ä»¶åˆ°è¿œç¨‹ä»“åº“"
              break
            else
              echo "âš ï¸  æŽ¨é€å¤±è´¥ï¼Œç¬¬ $i æ¬¡é‡è¯•..."
              git pull --rebase origin main
              sleep 2
            fi
            
            if [ $i -eq 3 ]; then
              echo "âŒ æŽ¨é€å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            fi
          done
      
      - name: ðŸ“¢ Create summary
        if: always()
        run: |
          echo "## ðŸ”„ Geosite DAT è½¬æ¢å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f rules/doh_foreign.dat ]; then
            FOREIGN_SIZE=$(ls -lh rules/doh_foreign.dat | awk '{print $5}')
            echo "- ðŸ“¦ **doh_foreign.dat**: ${FOREIGN_SIZE}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f rules/doh_china.dat ]; then
            CHINA_SIZE=$(ls -lh rules/doh_china.dat | awk '{print $5}')
            echo "- ðŸ“¦ **doh_china.dat**: ${CHINA_SIZE}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ç”Ÿæˆçš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`doh_foreign.dat\` - å¢ƒå¤– DoH (Protocol Buffers äºŒè¿›åˆ¶)" >> $GITHUB_STEP_SUMMARY
          echo "- \`doh_china.dat\` - å›½å†… DoH (Protocol Buffers äºŒè¿›åˆ¶)" >> $GITHUB_STEP_SUMMARY
          echo "- \`doh_foreign_info.txt\` - ä¿¡æ¯æ–‡ä»¶ï¼ˆä¾¿äºŽæŸ¥çœ‹ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- \`doh_china_info.txt\` - ä¿¡æ¯æ–‡ä»¶ï¼ˆä¾¿äºŽæŸ¥çœ‹ï¼‰" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— åœ¨ Mihomo ä¸­ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### æ–¹å¼ 1: ä½¿ç”¨è¿œç¨‹ DAT æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "geodata-mode: true" >> $GITHUB_STEP_SUMMARY
          echo "geox-url:" >> $GITHUB_STEP_SUMMARY
          echo "  geosite: \"https://raw.githubusercontent.com/${{ github.repository }}/main/rules/doh_foreign.dat\"" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "rules:" >> $GITHUB_STEP_SUMMARY
          echo "  - GEOSITE,doh-foreign,ðŸš€ èŠ‚ç‚¹é€‰æ‹©" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### æ–¹å¼ 2: ä¸‹è½½åˆ°æœ¬åœ°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸‹è½½ DAT æ–‡ä»¶åˆ° Mihomo ç›®å½•" >> $GITHUB_STEP_SUMMARY
          echo "2. é‡å‘½åä¸º \`geosite.dat\`" >> $GITHUB_STEP_SUMMARY
          echo "3. é…ç½®è§„åˆ™:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "rules:" >> $GITHUB_STEP_SUMMARY
          echo "  - GEOSITE,doh-foreign,ðŸš€ èŠ‚ç‚¹é€‰æ‹©" >> $GITHUB_STEP_SUMMARY
          echo "  - GEOSITE,doh-china,DIRECT" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… DAT æ–‡ä»¶å·²æ›´æ–°å¹¶æŽ¨é€åˆ° \`main\` åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸  DAT æ–‡ä»¶æ— å˜åŒ–ï¼Œæœªäº§ç”Ÿæ–°çš„æäº¤" >> $GITHUB_STEP_SUMMARY
          fi
