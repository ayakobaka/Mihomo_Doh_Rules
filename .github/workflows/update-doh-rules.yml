name: Update DoH Rules

on:
  # æ¯å¤© UTC 00:00 è‡ªåŠ¨è¿è¡Œ (åŒ—äº¬æ—¶é—´ 08:00)
  schedule:
    - cron: '0 0 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å½“é…ç½®æ–‡ä»¶æˆ–è„šæœ¬æ›´æ–°æ—¶è¿è¡Œ
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'main.py'
      - '.github/workflows/update-doh-rules.yml'

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸŒ Run DoH ruleset generator
        run: |
          python main.py
      
      - name: ğŸ“Š Show statistics
        run: |
          echo "=== ç”Ÿæˆçš„è§„åˆ™æ–‡ä»¶ ==="
          ls -lh rules/
          echo ""
          echo "=== å¢ƒå¤– DoH æ•°é‡ ==="
          grep -c "^  - " rules/doh_foreign.yaml || echo "0"
          echo ""
          echo "=== å›½å†… DoH æ•°é‡ ==="
          grep -c "^  - " rules/doh_china.yaml || echo "0"
      
      - name: ğŸ” Check for changes
        id: check_changes
        run: |
          if [ -d "rules" ] && [ -n "$(git status --porcelain rules/)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ’¾ Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add rules/*.yaml rules/*.list
          git commit -m "ğŸ¤– Auto-update DoH rules - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push
      
      - name: ğŸ“‹ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: doh-rules-${{ github.run_number }}
          path: |
            rules/doh_foreign.yaml
            rules/doh_china.yaml
            rules/doh_foreign.list
            rules/doh_china.list
          retention-days: 30
      
      - name: ğŸ·ï¸ Create release (optional)
        if: steps.check_changes.outputs.changed == 'true' && github.event_name == 'schedule'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: DoH Rules Update - ${{ github.run_number }}
          body: |
            ## ğŸ“‹ DoH è§„åˆ™é›†è‡ªåŠ¨æ›´æ–°
            
            **æ›´æ–°æ—¶é—´**: ${{ github.event.repository.updated_at }}
            **è§¦å‘æ–¹å¼**: å®šæ—¶ä»»åŠ¡
            
            ### ğŸ“¦ åŒ…å«æ–‡ä»¶
            - `doh_foreign.yaml` - å¢ƒå¤– DoH (å»ºè®®ä»£ç†)
            - `doh_china.yaml` - å›½å†… DoH (å»ºè®®ç›´è¿)
            - `doh_foreign.list` - å¢ƒå¤– DoH (DOMAIN-SUFFIX æ ¼å¼)
            - `doh_china.list` - å›½å†… DoH (DOMAIN-SUFFIX æ ¼å¼)
            
            ### ğŸ”— ä½¿ç”¨æ–¹æ³•
            åœ¨ Mihomo é…ç½®ä¸­æ·»åŠ :
            ```yaml
            rule-providers:
              doh-foreign:
                type: http
                behavior: domain
                url: "https://raw.githubusercontent.com/${{ github.repository }}/main/rules/doh_foreign.yaml"
                path: ./ruleset/doh_foreign.yaml
                interval: 86400
            
            rules:
              - RULE-SET,doh-foreign,ğŸš€ èŠ‚ç‚¹é€‰æ‹©
            ```
          files: |
            rules/doh_foreign.yaml
            rules/doh_china.yaml
            rules/doh_foreign.list
            rules/doh_china.list
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
