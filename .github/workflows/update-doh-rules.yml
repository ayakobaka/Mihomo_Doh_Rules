name: Update DoH Rules

on:
  # æ¯å¤© UTC 00:00 è‡ªåŠ¨è¿è¡Œ (åŒ—äº¬æ—¶é—´ 08:00)
  schedule:
    - cron: '0 0 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å½“é…ç½®æ–‡ä»¶æˆ–è„šæœ¬æ›´æ–°æ—¶è¿è¡Œ
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'main.py'
      - 'requirements.txt'
      - '.github/workflows/update-doh-rules.yml'

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # å…è®¸æŽ¨é€åˆ°ä»“åº“
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ—‚ï¸ Prepare output directory
        run: |
          # å¦‚æžœ rules æ˜¯æ–‡ä»¶ï¼Œåˆ é™¤å®ƒ
          if [ -f rules ]; then
            echo "âš ï¸  æ£€æµ‹åˆ° rules æ˜¯æ–‡ä»¶ï¼Œåˆ é™¤ä¸­..."
            rm rules
          fi
          
          # å¦‚æžœ rules ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
          if [ ! -d rules ]; then
            echo "âœ“ åˆ›å»º rules ç›®å½•"
            mkdir -p rules
          fi
          
          echo "âœ“ rules ç›®å½•å‡†å¤‡å®Œæˆ"
      
      - name: ðŸŒ Generate DoH rulesets
        run: |
          echo "å¼€å§‹ç”Ÿæˆ DoH è§„åˆ™é›†..."
          python main.py
          echo ""
          echo "ç”Ÿæˆå®Œæˆï¼"
      
      - name: ðŸ—‘ï¸ Remove classification log
        run: |
          if [ -f rules/classification_log.txt ]; then
            rm rules/classification_log.txt
            echo "âœ“ å·²åˆ é™¤ classification_log.txt"
          fi
      
      - name: ðŸ“Š Display statistics
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ ç”Ÿæˆçš„è§„åˆ™æ–‡ä»¶"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ls -lh rules/
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“ˆ è§„åˆ™ç»Ÿè®¡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -f rules/doh_foreign.yaml ]; then
            FOREIGN_COUNT=$(grep -c "^  - " rules/doh_foreign.yaml || echo "0")
            echo "ðŸŒ å¢ƒå¤– DoH åŸŸå: $FOREIGN_COUNT ä¸ª"
          fi
          
          if [ -f rules/doh_china.yaml ]; then
            CHINA_COUNT=$(grep -c "^  - " rules/doh_china.yaml || echo "0")
            echo "ðŸ‡¨ðŸ‡³ å›½å†… DoH åŸŸå: $CHINA_COUNT ä¸ª"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“ æ–‡ä»¶é¢„è§ˆ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -f rules/doh_foreign.yaml ]; then
            echo ""
            echo "ðŸ“„ doh_foreign.yaml (å‰ 10 è¡Œ):"
            head -n 10 rules/doh_foreign.yaml
          fi
          
          if [ -f rules/doh_china.yaml ]; then
            echo ""
            echo "ðŸ“„ doh_china.yaml (å‰ 10 è¡Œ):"
            head -n 10 rules/doh_china.yaml
          fi
      
      - name: ðŸ” Check for changes
        id: check_changes
        run: |
          git add rules/
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  è§„åˆ™æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ“ æ£€æµ‹åˆ°è§„åˆ™æ–‡ä»¶å˜åŒ–"
          fi
      
      - name: ðŸ’¾ Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # èŽ·å–ç»Ÿè®¡ä¿¡æ¯ç”¨äºŽ commit message
          FOREIGN_COUNT=$(grep -c "^  - " rules/doh_foreign.yaml || echo "0")
          CHINA_COUNT=$(grep -c "^  - " rules/doh_china.yaml || echo "0")
          
          git commit -m "ðŸ¤– Auto-update DoH rules

          - å¢ƒå¤– DoH: ${FOREIGN_COUNT} ä¸ªåŸŸå
          - å›½å†… DoH: ${CHINA_COUNT} ä¸ªåŸŸå
          - æ›´æ–°æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          Generated by GitHub Actions"
          
          git push
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… è§„åˆ™æ–‡ä»¶å·²æˆåŠŸæäº¤å¹¶æŽ¨é€åˆ°ä»“åº“"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: ðŸ“¢ Create summary
        if: always()
        run: |
          echo "## ðŸŽ‰ DoH è§„åˆ™é›†æ›´æ–°å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f rules/doh_foreign.yaml ]; then
            FOREIGN_COUNT=$(grep -c "^  - " rules/doh_foreign.yaml || echo "0")
            echo "- ðŸŒ **å¢ƒå¤– DoH**: ${FOREIGN_COUNT} ä¸ªåŸŸå" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f rules/doh_china.yaml ]; then
            CHINA_COUNT=$(grep -c "^  - " rules/doh_china.yaml || echo "0")
            echo "- ðŸ‡¨ðŸ‡³ **å›½å†… DoH**: ${CHINA_COUNT} ä¸ªåŸŸå" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ç”Ÿæˆçš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh rules/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ä½¿ç”¨æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "åœ¨ Mihomo é…ç½®ä¸­æ·»åŠ :" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "rule-providers:" >> $GITHUB_STEP_SUMMARY
          echo "  doh-foreign:" >> $GITHUB_STEP_SUMMARY
          echo "    type: http" >> $GITHUB_STEP_SUMMARY
          echo "    behavior: domain" >> $GITHUB_STEP_SUMMARY
          echo "    url: \"https://raw.githubusercontent.com/${{ github.repository }}/main/rules/doh_foreign.yaml\"" >> $GITHUB_STEP_SUMMARY
          echo "    path: ./ruleset/doh_foreign.yaml" >> $GITHUB_STEP_SUMMARY
          echo "    interval: 86400" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "rules:" >> $GITHUB_STEP_SUMMARY
          echo "  - RULE-SET,doh-foreign,ðŸš€ èŠ‚ç‚¹é€‰æ‹©" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… è§„åˆ™æ–‡ä»¶å·²æ›´æ–°å¹¶æŽ¨é€åˆ° \`main\` åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸  è§„åˆ™æ–‡ä»¶æ— å˜åŒ–ï¼Œæœªäº§ç”Ÿæ–°çš„æäº¤" >> $GITHUB_STEP_SUMMARY
          fi
