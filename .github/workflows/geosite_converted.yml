name: Convert DoH List to Geosite

permissions:
  contents: write

on:
  # å½“ Update DoH Rules å·¥ä½œæµè¿è¡Œå®Œæˆåè‡ªåŠ¨è§¦å‘
  workflow_run:
    workflows: ["Update DoH Rules"]
    types:
      - completed

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  convert-geosite:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Checkout domain-list-community
        run: |
          git clone --depth=1 https://github.com/v2fly/domain-list-community.git dlc
          cd dlc
          go mod download

      - name: ğŸ§± Build geosite.dat (åŒ…å« DoH åˆ†ç±»)
        run: |
          python - << 'PY'
          import os
          import shutil
          from pathlib import Path

          rules_dir = Path("rules")
          dlc_data_dir = Path("dlc") / "data"
          preview_file = rules_dir / "geosite_preview.txt"

          mapping = {
              "DOMAIN-SUFFIX": "domain",
              "DOMAIN": "full",
              "FULL": "full",
              "KEYWORD": "keyword",
          }

          inputs = [
              ("doh_foreign.list", "doh_foreign"),
              ("doh_china.list", "doh_china"),
          ]

          if not rules_dir.is_dir():
              raise SystemExit("rules ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡")

          # æ¸…ç©º dlc/data ç›®å½•ï¼Œåªä¿ç•™æˆ‘ä»¬ç”Ÿæˆçš„ DoH è§„åˆ™ï¼Œé¿å…æ··å…¥æ— å…³æ•°æ®
          if dlc_data_dir.exists():
              shutil.rmtree(dlc_data_dir)
          dlc_data_dir.mkdir(parents=True, exist_ok=True)

          preview_lines = ["# Geosite Content Preview (Text Format)\n# This file is for preview only. The actual database is geosite.dat (binary).\n"]

          for src_name, code_name in inputs:
              src = rules_dir / src_name
              if not src.exists():
                  continue

              values = []
              for line in src.read_text(encoding="utf-8").splitlines():
                  s = line.strip()
                  if not s or s.startswith("#") or "," not in s:
                      continue
                  rule_type, value = [p.strip() for p in s.split(",", 1)]
                  rule_type = rule_type.upper()
                  mapped = mapping.get(rule_type)
                  if not mapped or not value:
                      continue
                  values.append(f"{mapped}:{value}")
              
              content = "\n".join(sorted(set(values))) + "\n"
              
              # å†™å…¥ geosite æºæ–‡ä»¶
              out = dlc_data_dir / code_name
              out.write_text(content, encoding="utf-8")
              
              # å†™å…¥é¢„è§ˆæ–‡ä»¶
              preview_lines.append(f"\n# Category: {code_name}\n")
              preview_lines.append(content)
          
          preview_file.write_text("".join(preview_lines), encoding="utf-8")
          PY

          cd dlc
          go run ./
          cd ..

          mkdir -p rules
          mv -f dlc/dlc.dat rules/geosite.dat
          sha256sum rules/geosite.dat > rules/geosite.dat.sha256sum

      - name: ğŸ” Check for changes
        id: check_changes
        run: |
          if [ -d "rules" ] && [ -n "$(git status --porcelain rules/)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add rules/geosite.dat rules/geosite.dat.sha256sum rules/geosite_preview.txt
          git commit -m "ğŸ¤– Auto-build geosite.dat with DoH lists - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push origin HEAD:main

      - name: ğŸ“‹ Upload geosite artifacts
        uses: actions/upload-artifact@v4
        with:
          name: doh-geosite-${{ github.run_number }}
          path: |
            rules/geosite.dat
            rules/geosite.dat.sha256sum
            rules/geosite_preview.txt
          retention-days: 30
