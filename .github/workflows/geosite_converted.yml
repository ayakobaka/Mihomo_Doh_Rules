name: Convert DoH List to Geosite

permissions:
  contents: write

on:
  # å½“ Update DoH Rules å·¥ä½œæµè¿è¡Œå®Œæˆåè‡ªåŠ¨è§¦å‘
  workflow_run:
    workflows: ["Update DoH Rules"]
    types:
      - completed

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  convert-geosite:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ” Convert .list to geosite format
        run: |
          python - << 'PY'
          import os
          from datetime import datetime

          RULES_DIR = "rules"
          INPUT_FILES = ["doh_foreign.list", "doh_china.list"]

          type_mapping = {
              "DOMAIN-SUFFIX": "domain-suffix",
              "DOMAIN": "domain",
              "FULL": "full",
              "KEYWORD": "keyword",
          }

          if not os.path.isdir(RULES_DIR):
              print(f"âŒ rules ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡è½¬æ¢: {RULES_DIR}")
              raise SystemExit(0)

          for name in INPUT_FILES:
              src = os.path.join(RULES_DIR, name)
              if not os.path.exists(src):
                  print(f"âš ï¸ æºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡: {src}")
                  continue

              dst = os.path.join(RULES_DIR, name.replace(".list", ".geosite"))

              print(f"ğŸ”§ æ­£åœ¨è½¬æ¢ {src} -> {dst}")

              with open(src, "r", encoding="utf-8") as f:
                  lines = f.readlines()

              out_lines = []
              out_lines.append("# DoH Servers Ruleset - Geosite æ ¼å¼ (ç”¨äº Mihomo)\n")
              out_lines.append(f"# Source: {name}\n")
              out_lines.append(f"# Converted at: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}\n")
              out_lines.append("# Format: geosite text list (type:value)\n\n")

              for line in lines:
                  raw = line.rstrip("\n")
                  stripped = raw.strip()

                  # æ³¨é‡Šæˆ–ç©ºè¡ŒåŸæ ·ä¿ç•™
                  if not stripped or stripped.startswith("#"):
                      out_lines.append(raw + "\n")
                      continue

                  if "," not in stripped:
                      # éæ ‡å‡†è¡Œï¼Œç›´æ¥è·³è¿‡
                      continue

                  rule_type, value = [part.strip() for part in stripped.split(",", 1)]
                  mapped_type = type_mapping.get(rule_type.upper())
                  if not mapped_type or not value:
                      # æœªçŸ¥ç±»å‹æˆ–æ— å€¼ï¼Œè·³è¿‡
                      continue

                  out_lines.append(f"{mapped_type}:{value}\n")

              with open(dst, "w", encoding="utf-8") as f:
                  f.writelines(out_lines)

              print(f"âœ… å·²ç”Ÿæˆ: {dst}")

          PY

      - name: ğŸ” Check for changes
        id: check_changes
        run: |
          if [ -d "rules" ] && [ -n "$(git status --porcelain rules/)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add rules/*.geosite
          git commit -m "ğŸ¤– Auto-convert DoH .list to geosite format - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push

      - name: ğŸ“‹ Upload geosite artifacts
        uses: actions/upload-artifact@v4
        with:
          name: doh-geosite-${{ github.run_number }}
          path: |
            rules/doh_foreign.geosite
            rules/doh_china.geosite
          retention-days: 30
